## Saved Searches / Alerts for C2 Detection
## CraniacCombo CCDC
## Deploy to indexer: $SPLUNK_HOME/etc/apps/ccdc/local/savedsearches.conf
##
## These run as real-time or scheduled searches on the Splunk indexer.
## They detect beaconing, DNS anomalies, suspicious network activity,
## and known threat intel matches.

##############################################################
# 1. Beaconing Detection (Low-Jitter Periodic Connections)
##############################################################
[C2 - Beaconing Detection]
search = index=network OR index=windows sourcetype=sysmon OR sourcetype=netstat \
| where isnotnull(dest_ip) AND dest_ip!="127.0.0.1" AND dest_ip!="::1" \
| bin _time span=60s \
| stats count as connections dc(dest_port) as unique_ports by src_ip, dest_ip, process_name, _time \
| streamstats window=10 stdev(connections) as jitter avg(connections) as avg_conn by src_ip, dest_ip \
| where jitter < 0.5 AND avg_conn > 0 AND connections > 0 \
| stats count as beacon_intervals avg(jitter) as avg_jitter values(process_name) as processes by src_ip, dest_ip \
| where beacon_intervals > 5 \
| sort - beacon_intervals \
| table src_ip, dest_ip, beacon_intervals, avg_jitter, processes
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert.severity = 4
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
description = Detects periodic low-jitter connections indicative of C2 beaconing

##############################################################
# 2. Unusual Process Network Connections
##############################################################
[C2 - Unusual Process Network Activity]
search = index=windows sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=3 \
| where NOT match(Image, "(?i)(chrome|firefox|edge|iexplore|outlook|teams|onedrive|splunkd|svchost|system|lsass)") \
| stats count dc(DestinationIp) as unique_dests dc(DestinationPort) as unique_ports values(DestinationIp) as dest_ips by Image, SourceIp, Computer \
| where count > 3 OR unique_dests > 2 \
| sort - count \
| table Computer, Image, SourceIp, unique_dests, unique_ports, dest_ips, count
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */10 * * * *
is_scheduled = 1
alert.severity = 3
description = Flags processes making unusual outbound connections (Sysmon Event ID 3)

##############################################################
# 3. DNS Anomaly Detection (DGA / Tunneling)
##############################################################
[C2 - DNS DGA Detection]
search = index=windows sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=22 \
  OR (index=dns sourcetype=dnsmasq) \
  OR (index=dns sourcetype=named) \
| rex field=QueryName "^(?<subdomain>[^.]+)\.(?<domain>[^.]+\.[^.]+)$" \
| eval domain_len=len(subdomain) \
| eval has_numbers=if(match(subdomain, "\d{3,}"), 1, 0) \
| eval consonant_ratio=len(replace(subdomain, "[aeiouAEIOU]", "")) / max(len(subdomain), 1) \
| where domain_len > 15 OR has_numbers=1 OR consonant_ratio > 0.7 \
| stats count dc(QueryName) as unique_queries values(QueryName) as sample_queries by Image, Computer \
| where count > 5 \
| sort - count \
| table Computer, Image, count, unique_queries, sample_queries
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert.severity = 4
description = Detects domain generation algorithm (DGA) patterns in DNS queries

##############################################################
# 4. High-Volume DNS Queries (Exfiltration / Tunneling)
##############################################################
[C2 - DNS Exfiltration Volume]
search = index=windows sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=22 \
  OR (index=dns) \
| stats count dc(QueryName) as unique_domains by src_ip, Computer \
| where count > 500 OR unique_domains > 200 \
| sort - count \
| table Computer, src_ip, count, unique_domains
dispatch.earliest_time = -30m
dispatch.latest_time = now
cron_schedule = */10 * * * *
is_scheduled = 1
alert.severity = 3
description = Detects unusually high volume of DNS queries (possible DNS exfiltration)

##############################################################
# 5. Non-Standard Port Connections
##############################################################
[C2 - Non-Standard Port Outbound]
search = (index=network OR index=windows) sourcetype=sysmon OR sourcetype=netstat OR sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=3 \
| where isnotnull(dest_port) \
| eval standard_ports=if(dest_port IN (53, 80, 443, 8080, 8443, 3389, 22, 25, 110, 143, 993, 995, 587, 9997, 8089, 8000, 389, 636, 88, 445, 135, 139, 123, 161, 514), "standard", "non_standard") \
| where standard_ports="non_standard" \
| stats count dc(dest_port) as unique_ports values(dest_port) as ports by src_ip, dest_ip, process_name, Computer \
| where count > 3 \
| sort - count \
| table Computer, src_ip, dest_ip, process_name, unique_ports, ports, count
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert.severity = 3
description = Flags outbound connections on non-standard ports

##############################################################
# 6. All Outbound Connections Summary
##############################################################
[C2 - All Outbound Connections]
search = index=network "NETOUT:" \
| rex "SRC=(?<src_ip>\d+\.\d+\.\d+\.\d+)" \
| rex "DST=(?<dest_ip>\d+\.\d+\.\d+\.\d+)" \
| rex "DPT=(?<dest_port>\d+)" \
| where dest_ip!="127.0.0.1" AND dest_ip!="::1" \
| stats count dc(dest_port) as unique_ports earliest(_time) as first_seen latest(_time) as last_seen by src_ip, dest_ip, host \
| sort - count \
| table host, src_ip, dest_ip, unique_ports, count, first_seen, last_seen
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */10 * * * *
is_scheduled = 1
alert.severity = 2
description = Summary of all outbound connections from iptables NETOUT logs

##############################################################
# 7. New Outbound Connection Baseline
##############################################################
[C2 - New Outbound Connections]
search = (index=network OR index=windows) sourcetype=netstat OR sourcetype=sysmon OR sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=3 \
| where isnotnull(dest_ip) AND dest_ip!="127.0.0.1" AND dest_ip!="::1" \
| eval connection=src_ip.":".process_name."->".dest_ip.":".dest_port \
| stats earliest(_time) as first_seen latest(_time) as last_seen count by connection, src_ip, dest_ip, dest_port, process_name, Computer \
| where first_seen > relative_time(now(), "-15m") AND count < 5 \
| sort - first_seen \
| table Computer, src_ip, dest_ip, dest_port, process_name, first_seen, count
dispatch.earliest_time = -24h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert.severity = 2
description = Identifies brand new outbound connections (baseline comparison)

##############################################################
# 8. Service Inventory Dashboard
##############################################################
[Services - Running Inventory]
search = index=system sourcetype=service_inventory \
| dedup host \
| table host, _raw
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = 0 * * * *
is_scheduled = 0
description = Lists all running services across monitored hosts

[Network - Active Connections]
search = index=network sourcetype=netstat \
| dedup host \
| table host, _raw
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
is_scheduled = 0
description = Shows active network connections across monitored hosts

[Network - Listening Ports]
search = index=network sourcetype=listening_ports \
| dedup host \
| table host, _raw
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = 0 * * * *
is_scheduled = 0
description = Shows listening ports across monitored hosts
